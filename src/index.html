<!DOCTYPE html>
<html lang="en">
<head>
    <title>Textpod</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark" />
    <link rel="shortcut icon" href="{{FAVICON}}" />
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            daisyui: {
                themes: ["light", "dark", "cupcake", "bumblebee", "emerald", "corporate", "synthwave", "retro", "cyberpunk", "valentine", "halloween", "garden", "forest", "aqua", "lofi", "pastel", "fantasy", "wireframe", "black", "luxury", "dracula", "cmyk", "autumn", "business", "acid", "lemonade", "night", "coffee", "winter"]
            }
        }
    </script>
    <style>
        html { height: 100%; }
        body { min-height: 100vh; }
        #editor {
            width: 100%;
            height: 200px;
            resize: vertical;
            box-sizing: border-box;
            font-family: monospace;
        }
        .app-title {
            font-family: 'EB Garamond', serif;
        }
        .note {
            @apply card bg-base-100 shadow-xl mb-6;
        }
        .note-content {
            @apply card-body;
        }
        .note .noteMetadata {
            @apply text-sm opacity-70 mt-4 font-mono flex items-center justify-between;
        }
        .note .noteMetadata button {
            @apply btn btn-ghost btn-sm text-error hover:bg-error hover:text-error-content;
        }
        .note pre {
            @apply bg-base-200 p-4 rounded-lg my-4;
        }
        .note code {
            @apply bg-base-200 px-2 py-1 rounded;
        }
        .note img, .note iframe, .note video, .note audio, .note embed, .note svg {
            max-width: 100%;
            @apply rounded-lg;
        }
        .note p, .note li {
            @apply text-lg;
        }
        .note h1 { @apply text-2xl font-bold mb-4; }
        .note h2 { @apply text-xl font-bold mb-3; }
        .note h3 { @apply text-lg font-bold mb-2; }
    </style>
</head>

<body data-theme="light">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="navbar bg-base-100 rounded-box mb-6">
            <div class="flex-1">
                <h1 class="text-3xl font-bold app-title">Textpod</h1>
            </div>
            <div class="flex-none">
                <select class="select select-bordered w-full max-w-xs" id="theme-select">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="cupcake">Cupcake</option>
                    <option value="bumblebee">Bumblebee</option>
                    <option value="emerald">Emerald</option>
                    <option value="corporate">Corporate</option>
                    <option value="synthwave">Synthwave</option>
                    <option value="retro">Retro</option>
                    <option value="cyberpunk">Cyberpunk</option>
                    <option value="valentine">Valentine</option>
                    <option value="halloween">Halloween</option>
                    <option value="garden">Garden</option>
                    <option value="forest">Forest</option>
                    <option value="aqua">Aqua</option>
                    <option value="lofi">Lo-Fi</option>
                    <option value="pastel">Pastel</option>
                    <option value="fantasy">Fantasy</option>
                    <option value="wireframe">Wireframe</option>
                    <option value="black">Black</option>
                    <option value="luxury">Luxury</option>
                    <option value="dracula">Dracula</option>
                    <option value="cmyk">CMYK</option>
                    <option value="autumn">Autumn</option>
                    <option value="business">Business</option>
                    <option value="acid">Acid</option>
                    <option value="lemonade">Lemonade</option>
                    <option value="night">Night</option>
                    <option value="coffee">Coffee</option>
                    <option value="winter">Winter</option>
                </select>
            </div>
        </div>

        <div class="mb-8">
            <textarea id="editor" class="textarea textarea-bordered w-full text-lg"
                placeholder="Ctrl+Enter to save.&#10;Type / to search.&#10;Drag & drop files to attach.&#10;Start links with + to save local copies."></textarea>
            <div id="submitContainer" class="mt-4 text-right">
                <button id="submitButton" class="btn btn-primary">Submit</button>
            </div>
        </div>
        
        <div id="notes" class="space-y-6"></div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const notesDiv = document.getElementById('notes');
        const submitButton = document.getElementById('submitButton');
        const themeSelect = document.getElementById('theme-select');
        let searchTimeout = null;

        // Theme handling
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
        themeSelect.value = savedTheme;

        themeSelect.addEventListener('change', (e) => {
            setTheme(e.target.value);
        });

        window.addEventListener('load', async () => {
            displayNotes();
        });

        // fetches and displays all notes, optionally filtering them based on the query parameter `q`
        async function displayNotes() {
            const params = new URLSearchParams(window.location.search);
            const searchQuery = params.get('q');
            let response = await fetch('/notes');
            if (response.ok) {
                const notes = await response.json();
                notesDiv.innerHTML = notes
                    .filter(note => !searchQuery || note.content.toLowerCase().includes(searchQuery.toLowerCase()))
                    .map((note, i) => `
                    <div class="note">
                        <div class="note-content">
                            ${note.html}
                            <div class="noteMetadata">
                                <time datetime="${note.timestamp}">${note.timestamp}</time>
                                <button onclick="deleteNote(${i})" class="tooltip" data-tip="Delete note">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>`)
                    .reverse()
                    .join('');
            }
        }

        // saves a new note and refreshes the page
        async function saveNotes() {
            if (!editor.value) {
                return;
            }
            const saveResponse = await fetch('/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(editor.value)
            });

            // TODO more efficient way to do this than reloading all notes every time
            if (saveResponse.ok) {
                editor.value = '';
                displayNotes();
            }
        }

        // deletes note with index `idx`
        async function deleteNote(idx) {
            event.preventDefault();
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }

            deleteResponse = await fetch(`/notes/${idx}`, {
                method: 'DELETE'
            });

            if (deleteResponse.ok) {
                displayNotes();
            } else {
                alert('Failed to delete note');
            }
        }

        editor.addEventListener('input', async (e) => {
            const text = editor.value;
            if (text.startsWith('/')) {
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                searchTimeout = setTimeout(async () => {
                    const query = text.slice(1);
                    // Update URL with search parameter
                    const newUrl = query
                        ? `${window.location.pathname}?q=${encodeURIComponent(query)}`
                        : window.location.pathname;
                    window.history.replaceState({}, '', newUrl);

                    displayNotes();
                }, 200);
            } else if (text === '') {
                // Clear search parameter from URL
                window.history.replaceState({}, '', window.location.pathname);
            }
        });

        editor.addEventListener('keydown', async (e) => {
            if (e.ctrlKey && e.key === 'Enter' && !editor.value.startsWith('/')) {
                saveNotes();
            }
        });

        submitButton.addEventListener('click', async (e) => {
            saveNotes();
        })

        editor.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        editor.addEventListener('drop', async (e) => {
            e.preventDefault();

            const files = e.dataTransfer.files;
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const path = await response.json();
                    const filename = path.split('/').pop();

                    const position = editor.selectionStart;
                    const before = editor.value.substring(0, position);
                    const after = editor.value.substring(position);

                    // Link path with spaces needs to be wrapped in < >, Commonmark spec apparently handles this
                    const needsBrackets = path.includes(' ') || filename.includes(' ');
                    const formattedPath = needsBrackets ? `<${path}>` : path;

                    if (file.type.startsWith('image/')) {
                        editor.value = `${before}![${filename}](${formattedPath})${after}`;
                    } else {
                        editor.value = `${before}[${filename}](${formattedPath})${after}`;
                    }
                }
            }
        });
    </script>
</body>
</html>